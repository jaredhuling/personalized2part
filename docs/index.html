<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Two-Part Estimation of Treatment Rules for Semi-Continuous Data • personalized2part</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/cerulean/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="bootstrap-toc.css">
<script src="bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="pkgdown.css" rel="stylesheet">
<script src="pkgdown.js"></script><meta property="og:title" content="Two-Part Estimation of Treatment Rules for Semi-Continuous Data">
<meta property="og:description" content="Implements the methodology of Huling, Smith, and 
    Chen (2020) &lt;doi:10.1080/01621459.2020.1801449&gt;, which allows for subgroup identification 
    for semi-continuous outcomes by estimating individualized treatment rules. It uses a two-part 
    modeling framework to handle semi-continuous data by separately modeling the positive part 
    of the outcome and an indicator of whether each outcome is positive, but still results in a 
    single treatment rule. High dimensional data is handled with a cooperative lasso penalty, 
    which encourages the coefficients in the two models to have the same sign. ">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-home">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="index.html">personalized2part</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.2</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="reference/index.html">Reference</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/jaredhuling/personalized2part/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="contents col-md-9">


<div id="personalized2part" class="section level1">
<div class="page-header"><h1 class="hasAnchor">
<a href="#personalized2part" class="anchor"></a>personalized2part</h1></div>
<p>The <code>personalized2part</code> package implements the methodology of Huling, Smith, and Chen (2020), which allows for subgroup identification for semi-continuous outcomes by estimating individualized treatment rules. It uses a two part modeling (or hurdle modeling) framework to handle semi-continuous data by modeling separately the positive part of the outcome and an indicator of whether each outcome is positive, but still results in a single treatment rule. High dimensional data is handled with a cooperative lasso penalty, which encourages the coefficients in the two models to have the same sign.</p>
<div id="installation" class="section level2">
<h2 class="hasAnchor">
<a href="#installation" class="anchor"></a>Installation</h2>
<p>You can install the development version from <a href="https://github.com/jaredhuling/personalized2part">GitHub</a> with:</p>
<div class="sourceCode" id="cb1"><pre class="downlit">
<span class="co"># install.packages("devtools")</span>
<span class="kw">devtools</span>::<span class="fu"><a href="https://devtools.r-lib.org//reference/remote-reexports.html">install_github</a></span>(<span class="st">"jaredhuling/personalized2part"</span>)
</pre></div>
</div>
<div id="example" class="section level2">
<h2 class="hasAnchor">
<a href="#example" class="anchor"></a>Example</h2>
<p>This is a basic example which shows you how to solve a common problem:</p>
<div class="sourceCode" id="cb2"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="kw"><a href="https://github.com/jaredhuling/personalized2part">personalized2part</a></span>)
</pre></div>
<p>Simulate semicontinuous data with a heterogeneous treatment effect:</p>
<div class="sourceCode" id="cb3"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="fl">1</span>)
<span class="kw">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/sim_semicontinuous_data.html">sim_semicontinuous_data</a></span>(n.obs = <span class="fl">300</span>, n.vars = <span class="fl">50</span>)

<span class="kw">x</span>   <span class="op">&lt;-</span> <span class="kw">dat</span><span class="op">$</span><span class="kw">x</span>
<span class="kw">y</span>   <span class="op">&lt;-</span> <span class="kw">dat</span><span class="op">$</span><span class="kw">y</span>
<span class="kw">trt</span> <span class="op">&lt;-</span> <span class="kw">dat</span><span class="op">$</span><span class="kw">trt</span>
</pre></div>
<p>Use the built-in function <code>create.propensity.function</code> from the <a href="https://cran.r-project.org/package=personalized">personalized</a> package to construct a function that fits a propensity score model using 10-fold cross fitting:</p>
<div class="sourceCode" id="cb4"><pre class="downlit">
<span class="kw">propens_func</span> <span class="op">&lt;-</span> <span class="fu">create.propensity.function</span>(crossfit = <span class="fl">TRUE</span>, 
                                           nfolds.crossfit = <span class="fl">10</span>, 
                                           cv.glmnet.args = <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(type.measure = <span class="st">"auc"</span>))
</pre></div>
<p>Use the built-in function <code>create.augmentation.function</code> from the <a href="https://cran.r-project.org/package=personalized">personalized</a> package to construct outcome augmentation functions for the zero part model using 10-fold cross fitting:</p>
<div class="sourceCode" id="cb5"><pre class="downlit">
<span class="kw">aug_func_binary</span> <span class="op">&lt;-</span> <span class="fu">create.augmentation.function</span>(family = <span class="st">"binomial"</span>,
                                                crossfit = <span class="fl">TRUE</span>, 
                                                nfolds.crossfit = <span class="fl">10</span>, 
                                                cv.glmnet.args = <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(type.measure = <span class="st">"auc"</span>))
</pre></div>
<p>Use the built-in function <code>HDtweedie_kfold_aug</code> from the personalized2part package to construct outcome augmentation functions for the positive part model using 10-fold cross fitting using a penalized gamma regression model:</p>
<div class="sourceCode" id="cb6"><pre class="downlit">

<span class="kw">aug_func_positive</span> <span class="op">&lt;-</span> <span class="fu">function</span>(<span class="kw">x</span>, <span class="kw">y</span>, <span class="kw">trt</span>)
{
        <span class="fu"><a href="reference/HDtweedie_kfold_aug.html">HDtweedie_kfold_aug</a></span>(<span class="kw">x</span>, <span class="kw">y</span>, <span class="kw">trt</span>, K = <span class="fl">10</span>, p = <span class="fl">2</span>,
                            interactions = <span class="fl">TRUE</span>)
}
</pre></div>
<div class="sourceCode" id="cb7"><pre class="downlit">
<span class="kw">fitted_2part_subgrp_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/fit_subgroup_2part.html">fit_subgroup_2part</a></span>(<span class="kw">x</span>, <span class="kw">y</span>, <span class="kw">trt</span>, 
                                                propensity.func = <span class="kw">propens_func</span>,
                                                propensity.func.positive = <span class="kw">propens_func</span>, 
                                                augment.func.zero = <span class="kw">aug_func_binary</span>,
                                                augment.func.positive = <span class="kw">aug_func_positive</span>)

<span class="co">## the model print display takes the same form as fitted models from</span>
<span class="co">## the personalized package</span>
<span class="kw">fitted_2part_subgrp_model</span>
<span class="co">#&gt; family:    2part </span>
<span class="co">#&gt; loss:      2part </span>
<span class="co">#&gt; method:    </span>
<span class="co">#&gt; cutpoint:  1 </span>
<span class="co">#&gt; propensity </span>
<span class="co">#&gt; function:  propensity.func </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; benefit score: f(x), </span>
<span class="co">#&gt; Trt recom = 1*I(f(x)&gt;c)+0*I(f(x)&lt;=c) where c is 'cutpoint'</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Average Outcomes:</span>
<span class="co">#&gt;              Recommended 0    Recommended 1</span>
<span class="co">#&gt; Received 0 7.1015 (n = 93)  0.3277 (n = 49)</span>
<span class="co">#&gt; Received 1 0.4653 (n = 47) 6.4159 (n = 111)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Treatment effects conditional on subgroups:</span>
<span class="co">#&gt; Est of E[Y|T=0,Recom=0]-E[Y|T=/=0,Recom=0] </span>
<span class="co">#&gt;                           6.6363 (n = 140) </span>
<span class="co">#&gt; Est of E[Y|T=1,Recom=1]-E[Y|T=/=1,Recom=1] </span>
<span class="co">#&gt;                           6.0882 (n = 160) </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; NOTE: The above average outcomes are biased estimates of</span>
<span class="co">#&gt;       the expected outcomes conditional on subgroups. </span>
<span class="co">#&gt;       Use 'validate.subgroup()' to obtain unbiased estimates.</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; ---------------------------------------------------</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Benefit score quantiles (f(X) for 1 vs 0): </span>
<span class="co">#&gt;        0%       25%       50%       75%      100% </span>
<span class="co">#&gt; 4.414e-03 3.333e-01 1.220e+00 5.312e+00 2.131e+02 </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; ---------------------------------------------------</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Summary of individual treatment effects: </span>
<span class="co">#&gt; E[Y|T=1, X] / E[Y|T=0, X]</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Note: for survival outcomes, the above ratio is </span>
<span class="co">#&gt; E[g(Y)|T=1, X] / E[g(Y)|T=0, X], </span>
<span class="co">#&gt; where g() is a monotone increasing function of Y, </span>
<span class="co">#&gt; the survival time</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;      Min.   1st Qu.    Median      Mean   3rd Qu.      Max. </span>
<span class="co">#&gt;   0.00441   0.33333   1.21976  10.03182   5.31193 213.08937</span>
</pre></div>
<p>We can plot the coefficient curves for the two models as the following:</p>
<div class="sourceCode" id="cb8"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span>(mfrow = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">1</span>,<span class="fl">2</span>))
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span>(<span class="kw">fitted_2part_subgrp_model</span><span class="op">$</span><span class="kw">model</span><span class="op">$</span><span class="kw">hd2part.fit</span>, <span class="st">"zero"</span>)
</pre></div>
<p><img src="reference/figures/README-unnamed-chunk-2-1.png" width="100%"></p>
<div class="sourceCode" id="cb9"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span>(<span class="kw">fitted_2part_subgrp_model</span><span class="op">$</span><span class="kw">model</span><span class="op">$</span><span class="kw">hd2part.fit</span>, <span class="st">"positive"</span>)
</pre></div>
<p><img src="reference/figures/README-unnamed-chunk-2-2.png" width="100%"></p>
<p>Now evaluate value function on test set based on the estimated individualized treatment rule and compare with average outcome (a value function larger than the average outcome means that the ITR results in better outcomes than standard practice). The predict function returns predicted values for the heterogeneous treatment effect in terms of the risk ratio <span class="math inline"><em>E</em>[<em>Y</em>|<em>X</em>, <em>T</em> = 1]/<em>E</em>[<em>Y</em>|<em>X</em>, <em>T</em> =  − 1]</span>, so greater than 1 means the treatment is beneficial (if larger outcomes are preferred).</p>
<div class="sourceCode" id="cb10"><pre class="downlit">

<span class="kw">dat.test</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/sim_semicontinuous_data.html">sim_semicontinuous_data</a></span>(n.obs = <span class="fl">10000</span>, n.vars = <span class="fl">50</span>)

<span class="kw">x.test</span>   <span class="op">&lt;-</span> <span class="kw">dat.test</span><span class="op">$</span><span class="kw">x</span>
<span class="kw">y.test</span>   <span class="op">&lt;-</span> <span class="kw">dat.test</span><span class="op">$</span><span class="kw">y</span>

<span class="kw">predicted_hte</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span>(<span class="kw">fitted_2part_subgrp_model</span>, <span class="kw">x.test</span>)

<span class="co">## estmated test set value function:</span>
<span class="kw">personalized2part</span>:::<span class="fu">computeValue</span>(<span class="kw">y.test</span>, <span class="kw">predicted_hte</span>, <span class="kw">dat.test</span><span class="op">$</span><span class="kw">trt</span>,
                                 pi.x = <span class="kw">dat.test</span><span class="op">$</span><span class="kw">pi.x</span>, cutoff = <span class="fl">1</span>)
<span class="co">#&gt; [1] 4.708711</span>

<span class="co">## average outcome in the test set:</span>
<span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(<span class="kw">dat.test</span><span class="op">$</span><span class="kw">y</span>)
<span class="co">#&gt; [1] 3.854057</span>

<span class="co"># We can see that the estimated treatment rule results in better outcomes for the test set</span>
</pre></div>
<p>Now let’s compare with simply using a squared error loss under the framework of Chen, et al (2017) to estimate an ITR:</p>
<div class="sourceCode" id="cb11"><pre class="downlit">


<span class="kw">fsm_log</span> <span class="op">&lt;-</span> <span class="fu">fit.subgroup</span>(<span class="kw">x</span>, <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span>(<span class="kw">y</span><span class="op">+</span><span class="fl">0.1</span>), <span class="kw">trt</span>, propensity.func = <span class="kw">propens_func</span>, 
                    augment.func = <span class="fu">create.augmentation.function</span>(family=<span class="st">"gaussian"</span>),
                    loss = <span class="st">"sq_loss_lasso"</span>)

<span class="kw">fsm</span> <span class="op">&lt;-</span> <span class="fu">fit.subgroup</span>(<span class="kw">x</span>, <span class="kw">y</span>, <span class="kw">trt</span>, propensity.func = <span class="kw">propens_func</span>, 
                    augment.func = <span class="fu">create.augmentation.function</span>(family=<span class="st">"gaussian"</span>),
                    loss = <span class="st">"sq_loss_lasso"</span>)

<span class="kw">pred_hte_sqloss_log</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span>(<span class="kw">fsm_log</span>, <span class="kw">x.test</span>)
<span class="kw">pred_hte_sqloss</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span>(<span class="kw">fsm</span>, <span class="kw">x.test</span>)

<span class="co">## the value function is smaller than for the 2 part model</span>
<span class="kw">personalized2part</span>:::<span class="fu">computeValue</span>(<span class="kw">y.test</span>, <span class="kw">pred_hte_sqloss</span>, <span class="kw">dat.test</span><span class="op">$</span><span class="kw">trt</span>,
                                 pi.x = <span class="kw">dat.test</span><span class="op">$</span><span class="kw">pi.x</span>, cutoff = <span class="fl">0</span>)
<span class="co">#&gt; [1] 1.763163</span>

<span class="kw">personalized2part</span>:::<span class="fu">computeValue</span>(<span class="kw">y.test</span>, <span class="kw">pred_hte_sqloss_log</span>, <span class="kw">dat.test</span><span class="op">$</span><span class="kw">trt</span>,
                                 pi.x = <span class="kw">dat.test</span><span class="op">$</span><span class="kw">pi.x</span>, cutoff = <span class="fl">0</span>)
<span class="co">#&gt; [1] 4.172806</span>
</pre></div>
</div>
<div id="reference" class="section level2">
<h2 class="hasAnchor">
<a href="#reference" class="anchor"></a>Reference</h2>
<p><br><span class="math display">1</span><br> Huling J, Smith M, Chen G (2020). A two-part framework for estimating individualized treatment rules from semi-continuous outcomes. Journal of the American Statistical Association, in press.</p>
<p><br><span class="math display">2</span><br> Chen S, Tian L, Cai T, Yu M (2017). A general statistical framework for subgroup identification and comparative treatment scoring. Biometrics, 73(4):1199-209.</p>
</div>
</div>

  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <div class="links">
<h2>Links</h2>
<ul class="list-unstyled">
<li>Download from CRAN at <br><a href="https://cloud.r-project.org/package=personalized2part">https://​cloud.r-project.org/​package=personalized2part</a>
</li>
<li>Browse source code at <br><a href="https://github.com/jaredhuling/personalized2part/">https://​github.com/​jaredhuling/​personalized2part/​</a>
</li>
<li>Report a bug at <br><a href="https://github.com/jaredhuling/personalized2part/issues">https://​github.com/​jaredhuling/​personalized2part/​issues</a>
</li>
</ul>
</div>
<div class="license">
<h2>License</h2>
<ul class="list-unstyled">
<li>GPL (&gt;= 2)</li>
</ul>
</div>
<div class="citation">
<h2>Citation</h2>
<ul class="list-unstyled">
<li><a href="authors.html">Citing personalized2part</a></li>
</ul>
</div>
<div class="developers">
<h2>Developers</h2>
<ul class="list-unstyled">
<li>Jared Huling <br><small class="roles"> Author, maintainer </small> <a href="https://orcid.org/0000-0003-0670-4845" target="orcid.widget" aria-label="ORCID"><span class="fab fa-orcid orcid" aria-hidden="true"></span></a> </li>
</ul>
</div>

  <div class="dev-status">
<h2>Dev status</h2>
<ul class="list-unstyled">
<li><a href="https://travis-ci.org/jaredhuling/personalized2part"><img src="https://travis-ci.org/jaredhuling/personalized2part.svg?branch=master" alt="Build Status"></a></li>
<li><a href="https://cran.r-project.org/package=personalized2part"><img src="http://www.r-pkg.org/badges/version/personalized2part" alt="version"></a></li>
</ul>
</div>
</div>
</div>


      <footer><div class="copyright">
  <p>Developed by Jared Huling.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
