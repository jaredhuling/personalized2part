<!-- Generated by pkgdown: do not edit by hand -->
<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Fitting subgroup identification models for semicontinuous positive outcomes — fit_subgroup_2part • personalized2part</title>


<!-- jquery -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
<!-- Bootstrap -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/cerulean/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous" />


<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script>

<!-- bootstrap-toc -->
<link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script>

<!-- Font Awesome icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous" />

<!-- clipboard.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script>

<!-- headroom.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script>

<!-- pkgdown -->
<link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script>




<meta property="og:title" content="Fitting subgroup identification models for semicontinuous positive outcomes — fit_subgroup_2part" />
<meta property="og:description" content="Fits subgroup identification models" />




<!-- mathjax -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script>

<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->



  </head>

  <body data-spy="scroll" data-target="#toc">
    <div class="container template-reference-topic">
      <header>
      <div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">personalized2part</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.2</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="https://github.com/jaredhuling/personalized2part/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
      
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      

      </header>

<div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1>Fitting subgroup identification models for semicontinuous positive outcomes</h1>
    <small class="dont-index">Source: <a href='https://github.com/jaredhuling/personalized2part/blob/master/R/fit_subgroup_two_part.R'><code>R/fit_subgroup_two_part.R</code></a></small>
    <div class="hidden name"><code>fit_subgroup_2part.Rd</code></div>
    </div>

    <div class="ref-description">
    <p>Fits subgroup identification models</p>
    </div>

    <pre class="usage"><span class='fu'>fit_subgroup_2part</span>(
  <span class='kw'>x</span>,
  <span class='kw'>y</span>,
  <span class='kw'>trt</span>,
  propensity.func = <span class='kw'>NULL</span>,
  propensity.func.positive = <span class='kw'>NULL</span>,
  match.id = <span class='kw'>NULL</span>,
  augment.func.zero = <span class='kw'>NULL</span>,
  augment.func.positive = <span class='kw'>NULL</span>,
  cutpoint = <span class='fl'>1</span>,
  larger.outcome.better = <span class='fl'>TRUE</span>,
  penalize.ate = <span class='fl'>TRUE</span>,
  y_eps = <span class='fl'>1e-06</span>,
  <span class='kw'>...</span>
)</pre>

    <h2 class="hasAnchor" id="arguments"><a class="anchor" href="#arguments"></a>Arguments</h2>
    <table class="ref-arguments">
    <colgroup><col class="name" /><col class="desc" /></colgroup>
    <tr>
      <th>x</th>
      <td><p>The design matrix (not including intercept term)</p></td>
    </tr>
    <tr>
      <th>y</th>
      <td><p>The nonnegative response vector</p></td>
    </tr>
    <tr>
      <th>trt</th>
      <td><p>treatment vector with each element equal to a 0 or a 1, with 1 indicating
treatment status is active.</p></td>
    </tr>
    <tr>
      <th>propensity.func</th>
      <td><p>function that inputs the design matrix x and the treatment vector trt and outputs
the propensity score, ie Pr(trt = 1 | X = x). Function should take two arguments 1) x and 2) trt. See example below.
For a randomized controlled trial this can simply be a function that returns a constant equal to the proportion
of patients assigned to the treatment group, i.e.:
<code>propensity.func = function(x, trt) 0.5</code>.</p></td>
    </tr>
    <tr>
      <th>propensity.func.positive</th>
      <td><p>function that inputs the design matrix x and the treatment vector trt and outputs
the propensity score for units with positive outcome values, ie Pr(trt = 1 | X = x, Z = 1). Function should take
two arguments 1) x and 2) trt. See example below.
For a randomized controlled trial this can simply be a function that returns a constant equal to the proportion
of patients assigned to the treatment group, i.e.:
<code>propensity.func = function(x, trt) 0.5</code>.</p></td>
    </tr>
    <tr>
      <th>match.id</th>
      <td><p>a (character, factor, or integer) vector with length equal to the number of observations in <code>x</code>
indicating using integers or levels of a factor vector which patients are
in which matched groups. Defaults to <code>NULL</code> and assumes the samples are not from a matched cohort. Matched
case-control groups can be created using any method (propensity score matching, optimal matching, etc). If each case
is matched with a control or multiple controls, this would indicate which case-control pairs or groups go together.
If <code>match.id</code> is supplied, then it is unecessary to specify a function via the <code>propensity.func</code> argument.
A quick usage example: if the first patient is a case and the second and third are controls matched to it, and the
fouth patient is a case and the fifth through seventh patients are matched with it, then the user should specify
<code>match.id = c(1,1,1,2,2,2,2)</code> or <code>match.id = c(rep("Grp1", 3),rep("Grp2", 4)) </code>
the covariates <code>x</code>, and <code>trt</code> and outputs predicted values (on the probability scale) for the response using a model
constructed with <code>x</code>. <code>augment.func.zero()</code> can also be simply
a function of <code>x</code> and <code>y</code>. This function is used for efficiency augmentation.
When the form of the augmentation function is correct, it can provide efficient estimation of the subgroups. Some examples of possible
augmentation functions are:</p>
<p>Example 1: <code>augment.func &lt;- function(x, y) {lmod &lt;- glm(y ~ x, family = binomial()); return(fitted(lmod))}</code></p>
<p>Example 2:</p><pre>
<span class='kw'>augment.func</span> <span class='op'>&lt;-</span> <span class='fu'>function</span>(<span class='kw'>x</span>, <span class='kw'>y</span>, <span class='kw'>trt</span>) {
    <span class='kw'>data</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/data.frame.html'>data.frame</a></span>(<span class='kw'>x</span>, <span class='kw'>y</span>, <span class='kw'>trt</span>)
    <span class='kw'>lmod</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/stats/glm.html'>glm</a></span>(<span class='kw'>y</span> <span class='op'>~</span> <span class='kw'>x</span> <span class='op'>*</span> <span class='kw'>trt</span>, family = <span class='fu'><a href='https://rdrr.io/r/stats/family.html'>binomial</a></span>())
    <span class='co'>## get predictions when trt = 1</span>
    <span class='kw'>data</span><span class='op'>$</span><span class='kw'>trt</span> <span class='op'>&lt;-</span> <span class='fl'>1</span>
    <span class='kw'>preds_1</span>  <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/stats/predict.html'>predict</a></span>(<span class='kw'>lmod</span>, <span class='kw'>data</span>, type = <span class='st'>"response"</span>)

    <span class='co'>## get predictions when trt = -1</span>
    <span class='kw'>data</span><span class='op'>$</span><span class='kw'>trt</span> <span class='op'>&lt;-</span> <span class='op'>-</span><span class='fl'>1</span>
    <span class='kw'>preds_n1</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/stats/predict.html'>predict</a></span>(<span class='kw'>lmod</span>, <span class='kw'>data</span>, type = <span class='st'>"response"</span>)

    <span class='co'>## return predictions averaged over trt</span>
    <span class='fu'><a href='https://rdrr.io/r/base/function.html'>return</a></span>(<span class='fl'>0.5</span> <span class='op'>*</span> (<span class='kw'>preds_1</span> <span class='op'>+</span> <span class='kw'>preds_n1</span>))
}
</pre></td>
    </tr>
    <tr>
      <th>augment.func.zero</th>
      <td><p>(similar to augment.func.positive) function which inputs the
indicators of whether each response is positive (<code>1*(y &gt; 0)</code>),
the covariates <code>x</code>, and <code>trt</code> for all samples and outputs predicted values (on the link scale) for the response using a model
constructed with <code>x</code>. <code>augment.func.positive()</code> can also be simply
a function of <code>x</code> and <code>y</code>. This function is used for efficiency augmentation.</p></td>
    </tr>
    <tr>
      <th>augment.func.positive</th>
      <td><p>(similar to augment.func.zero) function which inputs the positive part response
(ie all observations in <code>y</code> which are strictly positive),
the covariates <code>x</code>, and <code>trt</code> and outputs predicted values (on the link scale) for the response using a model
constructed with <code>x</code>. <code>augment.func.positive()</code> can also be simply
a function of <code>x</code> and <code>y</code>. This function is used for efficiency augmentation.</p></td>
    </tr>
    <tr>
      <th>cutpoint</th>
      <td><p>numeric value for patients with benefit scores above which
(or below which if <code>larger.outcome.better = FALSE</code>)
will be recommended to be in the treatment group. Defaults to 1, since the benefit score is a risk ratio</p></td>
    </tr>
    <tr>
      <th>larger.outcome.better</th>
      <td><p>boolean value of whether a larger outcome is better/preferable. Set to <code>TRUE</code>
if a larger outcome is better/preferable and set to <code>FALSE</code> if a smaller outcome is better/preferable. Defaults to <code>TRUE</code>.</p></td>
    </tr>
    <tr>
      <th>penalize.ate</th>
      <td><p>should the treatment main effect (ATE) be penalized too?</p></td>
    </tr>
    <tr>
      <th>y_eps</th>
      <td><p>positive value above which observations in <code>y</code> will be considered positive</p></td>
    </tr>
    <tr>
      <th>...</th>
      <td><p>options to be passed to <code><a href='cv.hd2part.html'>cv.hd2part</a></code></p></td>
    </tr>
    </table>


    <h2 class="hasAnchor" id="examples"><a class="anchor" href="#examples"></a>Examples</h2>
    <pre class="examples"><div class='input'>
<span class='fu'><a href='https://rdrr.io/r/base/Random.html'>set.seed</a></span>(<span class='fl'>42</span>)

<span class='kw'>dat</span> <span class='op'>&lt;-</span> <span class='fu'><a href='sim_semicontinuous_data.html'>sim_semicontinuous_data</a></span>(<span class='fl'>250</span>, n.vars = <span class='fl'>15</span>)
<span class='kw'>x</span> <span class='op'>&lt;-</span> <span class='kw'>dat</span><span class='op'>$</span><span class='kw'>x</span>
<span class='kw'>y</span> <span class='op'>&lt;-</span> <span class='kw'>dat</span><span class='op'>$</span><span class='kw'>y</span>
<span class='kw'>trt</span> <span class='op'>&lt;-</span> <span class='kw'>dat</span><span class='op'>$</span><span class='kw'>trt</span>

<span class='kw'>prop_func</span> <span class='op'>&lt;-</span> <span class='fu'>function</span>(<span class='kw'>x</span>, <span class='kw'>trt</span>)
{
    <span class='kw'>propensmod</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/stats/glm.html'>glm</a></span>(<span class='kw'>trt</span> <span class='op'>~</span> <span class='kw'>x</span>, family = <span class='fu'><a href='https://rdrr.io/r/stats/family.html'>binomial</a></span>())

    <span class='kw'>propens</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/unname.html'>unname</a></span>(<span class='fu'><a href='https://rdrr.io/r/stats/fitted.values.html'>fitted</a></span>(<span class='kw'>propensmod</span>))
    <span class='kw'>propens</span>
}

<span class='kw'>fitted_model</span> <span class='op'>&lt;-</span> <span class='fu'>fit_subgroup_2part</span>(<span class='kw'>x</span>, <span class='kw'>y</span>, <span class='kw'>trt</span>, <span class='kw'>prop_func</span>, <span class='kw'>prop_func</span>)

<span class='kw'>fitted_model</span>
</div><div class='output co'>#&gt; family:    2part 
#&gt; loss:      2part 
#&gt; method:    
#&gt; cutpoint:  1 
#&gt; propensity 
#&gt; function:  propensity.func 
#&gt; 
#&gt; benefit score: f(x), 
#&gt; Trt recom = 1*I(f(x)&gt;c)+0*I(f(x)&lt;=c) where c is 'cutpoint'
#&gt; 
#&gt; Average Outcomes:
#&gt;              Recommended 0   Recommended 1
#&gt; Received 0 1.5903 (n = 62) 0.1273 (n = 66)
#&gt; Received 1 0.1498 (n = 25) 4.4873 (n = 97)
#&gt; 
#&gt; Treatment effects conditional on subgroups:
#&gt; Est of E[Y|T=0,Recom=0]-E[Y|T=/=0,Recom=0] 
#&gt;                            1.4406 (n = 87) 
#&gt; Est of E[Y|T=1,Recom=1]-E[Y|T=/=1,Recom=1] 
#&gt;                             4.36 (n = 163) 
#&gt; 
#&gt; NOTE: The above average outcomes are biased estimates of
#&gt;       the expected outcomes conditional on subgroups. 
#&gt;       Use 'validate.subgroup()' to obtain unbiased estimates.
#&gt; 
#&gt; ---------------------------------------------------
#&gt; 
#&gt; Benefit score quantiles (f(X) for 1 vs 0): 
#&gt;        0%       25%       50%       75%      100% 
#&gt; 1.706e-04 4.662e-01 5.409e+00 5.855e+01 1.649e+05 
#&gt; 
#&gt; ---------------------------------------------------
#&gt; 
#&gt; Summary of individual treatment effects: 
#&gt; E[Y|T=1, X] / E[Y|T=0, X]
#&gt; 
#&gt; Note: for survival outcomes, the above ratio is 
#&gt; E[g(Y)|T=1, X] / E[g(Y)|T=0, X], 
#&gt; where g() is a monotone increasing function of Y, 
#&gt; the survival time
#&gt; 
#&gt;      Min.   1st Qu.    Median      Mean   3rd Qu.      Max. 
#&gt;      0.00      0.47      5.41   1057.68     58.55 164909.90 </div><div class='input'>
<span class='co'>## correlation of estimated covariate-conditional risk ratio and truth</span>
<span class='fu'><a href='https://rdrr.io/r/stats/cor.html'>cor</a></span>(<span class='kw'>fitted_model</span><span class='op'>$</span><span class='kw'>benefit.scores</span>, <span class='kw'>dat</span><span class='op'>$</span><span class='kw'>treatment_risk_ratio</span>, method = <span class='st'>"spearman"</span>)
</div><div class='output co'>#&gt;            [,1]
#&gt; [1,] 0.07631469</div><div class='input'>

</div></pre>
  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <nav id="toc" data-toggle="toc" class="sticky-top">
      <h2 data-toc-skip>Contents</h2>
    </nav>
  </div>
</div>


      <footer>
      <div class="copyright">
  <p>Developed by Jared Huling.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
   </div>

  


  </body>
</html>


